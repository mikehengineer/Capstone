<html>
<head>
    <link rel="stylesheet" href="bootstrap.css">
    <script src = "/socket.io/socket.io.js" > </script>
    <script type=text/javascript src="https://code.jquery.com/jquery-1.12.1.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script>

    
    var socket = io.connect();
    socket.on("temp", tempUpdate);        //call function to update temperature value
    socket.on("light", lightUpdate);
    socket.on("dataReturn", updateDatabaseView);

    function tempUpdate(temp){
        console.log("In TempUpdate");
        var input = JSON.parse(temp);       //read the input from tempUpdate with JSON this should be an object with a temp field
        var newTemp = input.temp;            //get the temp field
        var celcius = (newTemp - 500) / 10;   //celcius calculation
        var fahrenheit = (celcius * 9/5) + 32;  //fahrenheit calculation
            fahrenheit = fahrenheit * 1000;
        var fTrim = fahrenheit % 10;
            fahrenheit = (fahrenheit-fTrim)/1000; //this and the two lines above allow us to isolate the hundreds spot (.XX) and trim anything beyond that
            celcius = celcius * 1000;
        var cTrim = celcius % 10;
            celcius = (celcius - cTrim)/1000;  //same trimming technique for celcius
        $("#temperaturef").html(" " + fahrenheit + " F");   //use Jquery to change the temperaturef DOM
        $("#temperaturec").html(" " + celcius + " C");      //use Jquery to change the temperaturec DOM
    }
    
    function lightUpdate(light){
        var input = JSON.parse(light);      //read input from lightUpdate
        var newLight = input.light;         //get the light field
        $("#lightlevel").html(" " + newLight);  //use Jquery to change the lightlevel DOM
    }
    function returnMonth(yearEntry){      //we need a function to return the month for our title
                    var returnedMonth;
                    switch(yearEntry){
                        case 1:
                            returnedMonth = 'January';
                        break;
                        case 2:
                            returnedMonth = 'February';
                        break;
                        case 3:
                            returnedMonth = 'March';
                        break;
                        case 4:
                            returnedMonth = 'April';
                        break;
                        case 5:
                            returnedMonth = 'May';
                        break;
                        case 6:
                            returnedMonth = 'June';
                        break;
                        case 7:
                            returnedMonth = 'July';
                        break;
                        case 8:
                            returnedMonth = 'August';
                        break;
                        case 9:
                            returnedMonth = 'September';
                        break;
                        case 10:
                            returnedMonth = 'October';
                        break;
                        case 11:
                            returnedMonth = 'November';
                        break;
                        case 12:
                            returnedMonth = 'December';
                        break;
                        default:
                            returnedMonth = 'January';
                        break;
                    }
                return returnedMonth;
    }
    
    function updateDatabaseView(returnedData1, returnedData2, chartType, dbStringArray){
        if (returnedData1.time.length < 1 || returnedData2.value.length < 1){
            $("#errorflag").html("No data matches those search parameters.");   //if either of our data arrays have a 0 length, display an error and do not render the chart
            return;
        }
        
        var chartMonth1;
        var chartMonth2;
        var returnedData3 = returnedData1;
        var returnedData4 = returnedData2;
        var chartSub;
        var charTitle;
        
        var lastEntry = returnedData1.time.length - 1;   //we need the array address of our last date in our data array
            var Year1 = Math.floor(returnedData1.time[0]/10000000000);   //Year1, Month1, and Day1 correspond to the first time entry in our database we need to do some calculations on our date integer to isolate the digits we want
            var Month1 = Math.floor(returnedData1.time[0]/100000000);
                Month1 = Month1 % 100;
            var Day1 = Math.floor(returnedData1.time[0]/1000000);
                Day1 = Day1 % 100;
            var Year2 = Math.floor(returnedData1.time[lastEntry]/10000000000);
            var Month2 = Math.floor(returnedData1.time[lastEntry]/100000000);
                Month2 = Month2 % 100;
            var Day2 = Math.floor(returnedData1.time[lastEntry]/1000000);
                Day2 = Day2 % 100;
            chartMonth1 = returnMonth(Month1);  //lets get the string representation of the month of the data, this will go in our chart title
            chartMonth2 = returnMonth(Month2);  //this is the string representation of the month of our last date
            if(chartType == 1){
                chartSub = 'Temperature' //what type of data are displaying 
            }
            else if (chartType == 2){
                chartSub = 'Light'
            }
            function titleString(){
                if (chartMonth1 == chartMonth2){
                    if(Day1 == Day2){
                        charTitle = Day1 + ' ' + chartMonth1 + ' ' + Year1 //if we have the same month and same day between the first and last date, there is no reason to display a range in our title
                    }
                    else{
                        charTitle = Day1 + '  ' + Day2 + ' ' + chartMonth1 + ' ' + Year1 //if our days are different display day range but keep month 
                    }    
                }
                else{
                    charTitle = Day1 + ' ' + chartMonth1 + ' ' + Year1 + ' - ' + Day2 + ' ' + chartMonth2 + ' ' + Year2 //if month is different then we need both a day and month range in our title
                }
            }
            titleString();
            
        $(function () {
            $('#container').highcharts({
                title: {
                    text: charTitle
                },

                subtitle: {
                    text: chartSub
                },
                yAxis: {
                    title: {
                        text: 'Temperature'
                    }
                },
                xAxis: {
                    title: {
                        text: 'Time Hr : Min : Sec'
                    },
                    categories: dbStringArray.time
                },
                plotOptions: {
                    line: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                series: [{
                    name: 'Readings',
                    data: returnedData4.value
                }]
            });
        });
    }
    </script>
</head>

<body>
    <h1 style="font-size:50pt;">Temperature (Fahrenheit)</h1>
    <h2 style="font-size:25pt;"id="temperaturef"></h2>
    <h1 style="font-size:50pt;">Temperature (Celcius)</h1>
    <h2 style="font-size:25pt;"id="temperaturec"></h2>
    <h1 style="font-size:50pt;">Current Light Level</h1>
    <h2 style="font-size:25pt;"id="lightlevel"></h2>
    </p>
    </p>
    
    
    Temperature Servo Angle (1-10): <input type="textbox" id="tempA" value="Enter an angle" onfocus="if (this.value=='Enter an angle') this.value ='';"/>
    <button onclick="moveTempServo()">Move Servo</button>
    </p>
    
    Light Servo Angle (1-10): <input type="textbox" id="lightA" value="Enter an angle" onfocus="if (this.value=='Enter an angle') this.value ='';"/>
    <button onclick="moveLightServo()">Move Servo</button>
    </p>
    </p>
    
    Chart Services:
    </p>
    <input type="textbox" id="dbLow" value="Enter chart lowrange" onfocus="if (this.value=='Enter an angle') this.value ='';"/>
    </p>
    <input type="textbox" id="dbHigh" value="Enter chart lowrange" onfocus="if (this.value=='Enter an angle') this.value ='';"/>
    </p>
    <input type="textbox" id="dbqType" value="Temp or Light Range" onfocus="if (this.value=='Enter an angle') this.value ='';"/>
    </p>
    <input type="textbox" id="dbType" value="Type temp or light for type of graph:" onfocus="if (this.value=='Enter an angle') this.value ='';"/>
    </p>
    </p>
    <button onclick="generateChart()">Generate Chart</button>
    </p>
    <h2 style="font-size:25pt;"id="errorflag"></h2>
    </p>
    <div id="container" style="height: 400px"></div>
    <script>

       
        function moveTempServo(){
            var tAngle = document.getElementById("tempA").value;
            var newtAngle = tAngle/10;
            socket.emit('moveTServo', newtAngle);
        }
        
        function moveLightServo(){
            var lAngle = document.getElementById("lightA").value;
            var newlAngle = lAngle/10;
            socket.emit('moveLServo', newlAngle);
        }
        
        function generateChart(){           //we need to grab the parameters from the user and run our query to build our chart
            var dLow = document.getElementById("dbLow").value;
        	var dHigh = document.getElementById("dbHigh").value;
        	var dType = document.getElementById("dbType").value;
        	var qType = document.getElementById("dbqType").value;
            socket.emit('database', dLow, dHigh, dType, qType);   //low date/value range, high date/value range, which table are we pulling from (temp or light), what range are we searching in (date or value)
        }
        
        function grabTime(){// lets grab the time and return it as a large integer value
            var time = new Date();
    
            var year = time.getFullYear();
            var month = time.getMonth() + 1; //starts at 0 so add one
            var day = time.getDate();
            var hour = time.getHours();
            var minute = time.getMinutes();
            var second = time.getSeconds();
    
            //lets get these into the correct place holding form XXXX(year)XX(month)XX(day)XX(hour)XX(minute)XX(second) -> full: XX,XXX,XXX,XXX,XXX 14 digit integer
            year = year * 10000000000;
            month = month * 100000000;
            day = day * 1000000;
            hour = hour * 10000;
            minute = minute * 100;
    
            var integerTime = 0;
            integerTime = second + minute + hour + day + month + year;
    
            return integerTime;
        }
    </script>
</body>
</html>